# AI 角色扮演平台 - 需求分析与技术方案

## 一、需求分析

### 1. 目标用户与核心痛点



| 目标用户类型     | 核心痛点                                            |
| ---------- | ----------------------------------------------- |
| IP / 文化爱好者 | 现有 IP 互动形式（游戏固定对话、影视片段）缺乏自由度，难以个性化交流；缺少同好深度讨论渠道 |
| 学生 / 老师    | 传统学习方式被动枯燥，抽象知识（哲学、历史）难通过文字理解；缺乏沉浸式记忆场景         |
| 娱乐者        | 普通聊天机器人无 “人格感”，对话空洞；社交平台互动成本高，难获专属角色即时回应        |

### 2. 功能需求与优先级

#### （1）核心功能（必须实现）



*   **角色搜索与选择**：支持按名称、领域（文学 / 历史 / 影视等）、标签（幽默 / 严肃）搜索；提供热门角色推荐。

*   **语音实时聊天**：覆盖 “用户语音输入→语音转文字→LLM 处理→文字转语音→AI 语音输出” 全链路，保障对话流畅性。

*   **角色人设还原**：AI 精准模仿角色语气、用词习惯、知识背景（如苏格拉底善用反问，哈利波特常用魔法术语）。

#### （2）体验增强功能（核心稳定后开发）



*   **聊天记录保存与回溯**：支持查看 / 回放历史对话，提供精彩片段收藏功能。

*   **多语言支持**：角色可切换回应语言（如莎士比亚用中文聊戏剧，保留英文表达习惯）。

*   **角色状态调整**：用户可微调角色 “活跃度”“严肃度”（如让 “鲁迅” 更犀利或更温和）。

#### （3）高级扩展功能（长期迭代）



*   **角色定制**：用户上传原创角色设定（如小说角色），AI 学习后生成专属互动角色。

*   **场景化互动**：支持指定场景（如 “哈利波特在霍格沃茨食堂”），AI 根据场景调整回应内容。

*   **跨角色互动**：允许邀请两个角色对话（如爱因斯坦与霍金讨论黑洞），观察观点碰撞。

## 二、技术选型

### 1. 前端技术栈



| 模块    | 技术选型                                                                                                                                       |
| ----- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| 框架    | React + TypeScript（组件化开发，类型安全与后端 protobuf 形成闭环）                                                                                            |
| UI 框架 | Tailwind CSS + Headless UI（快速定制角色风格化界面，适配动态交互）                                                                                             |
| 状态管理  | Redux Toolkit（全局状态管理） + React Query（服务端状态缓存，减少重复请求）                                                                                        |
| 数据交互  | - HTTP 请求：axios + protobufjs（解析后端 protobuf 响应）- 实时通信：websocket 客户端（对接后端 gorilla/websocket）- 语音处理：react-media-recorder（按 VoiceChunk 格式分片录制） |

### 2. 后端技术栈



| 模块     | 技术选型                                                                                                     |
| ------ | -------------------------------------------------------------------------------------------------------- |
| Web 框架 | Gin + 自定义 protobuf 绑定器（高性能路由，直接解析 protobuf 请求，减少序列化开销）                                                   |
| 实时通信   | gorilla/websocket（成熟稳定，支持自定义缓冲区，适配语音分片传输）                                                                |
| API 网关 | Kong（路由转发、基于 protobuf 的接口验证、热门角色 API 限流 (QPS=1000)）                                                      |
| 中间件层   | - 认证中间件：JWT 验证，解析后映射为 User protobuf 结构体- 日志中间件：Zap 记录 protobuf 关键字段- 异常捕获：统一包装为 BaseResponse protobuf 格式 |

### 3. AI 服务集成



| 功能模块       | 技术选型                                                                |
| ---------- | ------------------------------------------------------------------- |
| 七牛云 AI 集成     | 七牛云 ASR/TTS/LLM（主接入点：wss://openai.qiniu.com/v1） |              

### 4. 数据存储



| 存储类型   | 技术选型                                                                              |
| ------ | --------------------------------------------------------------------------------- |
| 关系型数据库 | PostgreSQL + `github.com/jackc/pgx/v5`（存储用户 / 角色基础数据，二进制协议高效映射 protobuf）          |
| 文档数据库  | MongoDB + `go.mongodb.org/mongo-driver/mongo`（存储聊天记录、角色完整人设，BSON 与 protobuf 互转便捷） |
| 缓存     | Redis + `github.com/redis/go-redis/v9`（缓存热门角色人设、用户会话状态，降低数据库压力）                   |

### 5. 基础设施与 DevOps



| 模块  | 技术选型                                                        |
| --- | ----------------------------------------------------------- |
| 容器化 | Docker + Kubernetes（Go 二进制镜像体积小，K8s 支持按 WebSocket 连接数自动扩缩容） |
| 监控  | Prometheus + Grafana（暴露指标：WebSocket 连接数、AI 接口耗时、语音分片延迟）     |
| 日志  | Zap（结构化日志，记录 protobuf 字段） + ELK（检索异常会话，如语音分片丢失）             |

## 三、系统架构设计

### 1. 架构分层（模块化单体，预留微服务扩展点）



```
用户层
  │
  ├─ Web端（React + protobufjs）
  │
API网关（Kong）
  ├─ 路由转发（/user/*→用户服务，/role/*→角色服务，/chat/*→聊天服务）
  ├─ 接口验证（基于protobuf字段规则校验）
  └─ 限流控制（热门角色API限制QPS=1000）
  │
后端服务（Gin + Go协程池）
  ├─ 中间件层
  │   ├─ 认证中间件：JWT验证，解析为User protobuf结构体
  │   ├─ 日志中间件：Zap记录请求ID、protobuf关键字段
  │   └─ 异常捕获：统一包装为BaseResponse protobuf格式
  │
  ├─ 业务模块
  │   ├─ 用户模块：注册/登录/个人信息（CRUD PostgreSQL）
  │   ├─ 角色模块：搜索（PostgreSQL索引+Redis缓存）、详情（MongoDB+七牛云RAG）
  │   ├─ 聊天模块：
  │   │   ├─ 历史记录：MongoDB分页查询，返回ChatMessage列表
  │   │   └─ 实时通信：gorilla/websocket管理会话，传输语音分片
  │   └─ AI处理模块（核心）：
  │       ├─ ASR服务：对接七牛云流式ASR，转语音为文本
  │       ├─ LLM服务：注入角色人设，调用七牛云LLM生成回应
  │       └─ TTS服务：调用七牛云TTS生成语音，上传至OSS
  │
数据层
  ├─ PostgreSQL：用户表（users）、角色基础表（roles_basic）
  ├─ MongoDB：角色人设表（roles_persona）、聊天记录表（chat_records）
  └─ Redis：热门角色缓存、会话状态缓存、限流计数器
  │
基础设施层
  ├─ 容器集群（K8s）：部署后端服务、数据库、缓存
  ├─ 云存储（七牛云OSS）：存储TTS语音文件
  └─ 监控系统（Prometheus + Grafana）：监控服务性能与AI接口状态
```
### 2. 核心业务模块详解

#### 实时语音聊天全链路



#####  1. 前端初始化会话
用户选择角色（如哈利波特），前端生成session_id，通过 WebSocket 发送StartChatRequest（protobuf 格式）至后端，后端创建 ASR 会话并连接七牛云 ASR 服务。
#####   2. 前端录音与分片传输
前端用react-media-recorder录制语音，按 100ms 分片为VoiceChunk（含session_id、chunk_index、voice_data），通过 WebSocket 流式推送至后端。
后端转发至七牛云 ASR
后端接收分片后，按七牛云 ASR 协议（GZIP 压缩 + 协议头封装）转发至wss://openai.qiniu.com/v1/voice/asr，七牛云实时返回识别文本。
#####   3. LLM 生成角色回应
后端检测到用户沉默 1.5 秒后，提取新增识别文本，结合 MongoDB 中的角色人设（如 “哈利波特，15 岁，常用‘梅林的胡子’口头禅”）与七牛云 RAG 知识库，调用deepseek-v3模型生成回应文本。
#####   4. 七牛云 TTS 合成语音
后端获取 LLM 文本后，调用七牛云 TTS 接口（指定角色自定义音色 ID），流式接收语音分片，合并后上传至七牛云 OSS，生成公开访问 URL。
#####   5. 前端播放与记录存储
后端将语音 URL 与文本封装为AIResponse protobuf，通过 WebSocket 推送给前端，前端播放语音并展示文本；同时将聊天记录存入 MongoDB。

## 四、AI 角色必备技能



1.  **知识输出**：基于角色背景提供专业内容（如爱因斯坦推导物理公式、李时珍讲解草药知识）。

2.  **场景化行动模拟**：在指定场景中做出符合角色的行为回应（如哈利波特讲解 “守护神咒使用步骤”）。

3.  **情感共鸣**：感知用户语气（失落 / 兴奋），动态调整回应态度（如林黛玉用共情诗句安慰失落用户）。

